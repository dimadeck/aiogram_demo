# Aiogram Demo

## ТЗ

### Создание бота и обработка команд
    Создать Telegram-бота, который отвечает на команду /start сообщением "Добро пожаловать в наш бот!", и команду /help сообщением "Доступные команды: /start, /help, /echo, /photo".

    Критерии проверки:
        Корректное создание бота и настройка диспетчера
        Обработка команд /start и /help
        Команда /echo
        Добавить команду /echo, которая будет возвращать пользователю его собственное сообщение.
        Критерии проверки:
        Корректная обработка команды /echo
        Правильный возврат сообщения пользователя

### Inline кнопки и обработка коллбеков
    Создать inline-кнопки с опциями "Выбор 1" и "Выбор 2”. При нажатии на любую из них бот должен отвечать соответствующим сообщением "Вы выбрали Выбор 1" или "Вы выбрали Выбор 2".

    Критерии проверки:
        Корректная работа inline-кнопок
        Правильная обработка коллбеков и ответ на нажатие

### Хранение данных пользователя с использованием FSM (Finite State Machine)
    Реализовать бота, который запрашивает у пользователя его имя и возраст, сохраняя эти данные с использованием FSM и выводит их в конце.
    
    Критерии проверки:
        Корректная реализация FSM
        Правильное сохранение и отображение введенных данных

### Загрузка и обработка изображений
    Добавить возможность пользователю отправлять изображение, на которое бот будет отвечать размером изображения в пикселях (ширина x высота).
    
    Критерии проверки:
        Корректная загрузка изображений
        Правильное определение и вывод размеров изображения

### Интеграция с базой данных SQLite
    Создать таблицу пользователей в базе данных SQLite и сохранить в неё данные пользователя (ID, имя, возраст). Реализовать команду /users для вывода всех пользователей.

    Критерии проверки:
        Корректная работа с SQLite
        Правильное сохранение и извлечение данных
        Корректный вывод списка пользователей

### Обработка данных с API
    Реализовать команду /weather, которая будет запрашивать у пользователя название города и выводить текущую погоду, используя API (например, OpenWeatherMap).
    
    Критерии проверки:
        Корректная работа с API
        Правильная обработка и вывод данных о погоде

### Периодические задачи (Scheduled Tasks)
    Добавить функционал, который будет отправлять пользователям сообщение "Не забудьте проверить уведомления!" каждый день в 9:00 утра.
    
    Критерии проверки:
        Корректная реализация периодических задач
        Отправка сообщения в заданное время

### Напоминание о необходимости ответа через 15 минут
    Пользователю бот отправляет сообщение: «Привет, «имя пользователя»! Как ты сегодня?». Добавить функционал, при котором бот отправит пользователю сообщение «вы забыли ответить», если пользователь не ответил на вопрос в течение 15 минут. Например, если бот задаёт пользователю вопрос, и тот не отвечает, то через 15 минут бот должен отправить сообщение "Вы забыли ответить".
    
    Критерии проверки: 
        Корректная реализация отслеживания времени ожидания ответа.
        Отправка напоминания через 15 минут, если ответа нет.
        Отмена напоминания, если пользователь ответил до истечения 15 минут.
        Использовать флаги middleware в aiogram 

### Обработка ошибок и исключений
    Реализовать обработку исключений, чтобы бот отправлял сообщение "Произошла ошибка, попробуйте позже" в случае любой ошибки.
    
    Критерии проверки:
        Корректная обработка исключений
        Правильное уведомление пользователя об ошибке
        В случае возникновения ошибки отправлять пользователю сообщение "Произошла ошибка, попробуйте позже".
        Логировать ошибки для дальнейшего анализа и устранения.
        примеры ошибок: пользователь вместо фото для определения размеров загрузил файл. Или вместо возраста в виде цифр, ввел буквами и тд 

## Реализация

### Архитектура
    
    Исходный код разделен по пакетам
        core -> Содержит код, не относящийся к боту напрямую, но необходимый для выполнения команды /weather 
        db -> Миграции и описание моделей
        telegram_bot -> Создание бота, компоненты и middlewares
            Компоненты разделены по функционалу на routers, для быстрого подключения и отключения от бота; messages, для описания текстов отправляемых сообщений
        utils -> Настройки приложения


### Создание бота и обработка команд

[dispatcher.py](src%2Ftelegram_bot%2Fdispatcher.py)

    Создание и настройка бота, диспетчера, подключение роутеров компонентов и middlewares. 
    Все команды бота можно просмотреть в интерфейсе бота (написать "/" и откроется меню с актуальными командами) 

### Inline кнопки и обработка коллбеков

[inline](src%2Ftelegram_bot%2Fcomponents%2Finline)

    Компонент для демонстрации отправки keyboard с обработкой колбеков.

### Хранение данных пользователя с использованием FSM (Finite State Machine)

[state](src%2Ftelegram_bot%2Fcomponents%2Fstate)

    Компонент для демонстрации запоминания состояний диалога. Спрашивает имя и возраст. 
    После завершения выводит информацию в сообщении.

### Загрузка и обработка изображений

[image](src%2Ftelegram_bot%2Fcomponents%2Fimage)

    Обрабатывает входящее сообщение с контентом Photo и командой /photo. 
    Информацию о размере получает из метадаты объекта. Дополнительно скачивает, чтобы закрыть требование скачивания.

### Интеграция с базой данных SQLite

[db](src%2Fdb)

    Был выбран путь изменить технологию на "более подходящую" - Postgresql, так как на "боевых" проектах SQLite не принято использовать. 
    Реализовано сохранение информации о пользователе (автоматически, через user_middleware.py).
    Информация о пользователе дополнительно передается в каждый обработчик, где необходим доступ
    Команда /users доступна только для администратора (Включение роли /admin_on, отключение /admin_off)

### Обработка данных с API

[weather Component](src%2Ftelegram_bot%2Fcomponents%2Fweather)

[weather API](src%2Fcore%2Fweather)

    Реализована команда /weather в соответствии с ТЗ. Используется OpenWeatherMap

### Периодические задачи (Scheduled Tasks)

[scheduler](src%2Ftelegram_bot%2Fcomponents%2Fscheduler)

    К диспетчеру подключен AsyncIOScheduler (apscheduler). При старте задается время для отправки запланированного сообщения.

### Напоминание о необходимости ответа через 15 минут

[scheduler router.py](src%2Ftelegram_bot%2Fcomponents%2Fuser%2Frouter.py)

    Демо включается по команде /remind_me. Запоминается состояние и планируется запуск задачи. 
    Если пользователь не написал за 15 минут ни одного сообщения, то задача исполняется.
    При написании сообщения в необходимый период, состояние сбрасывается и задача удаляется из очереди.

### Обработка ошибок и исключений

[exception_middleware.py](src%2Ftelegram_bot%2Fmiddlewares%2Fexception_middleware.py)

    При ошибке во время выполнения команд, пользователь получит сообщение об этом.
    При включенном флаге DEBUG дополнительно будет отправлен тип ошибки.
    Реализовано через exception_middleware.py
    Дополнительно в base router подключена обработка сообщений, для которых нет обработки. Выдается сообщение о неизвестной команде. 

## Настройка и запуск

    Склонировать репозиторий

    $ git clone https://github.com/dimadeck/aiogram_demo
    $ cd https://github.com/dimadeck/aiogram_demo
    $ nano .env

    Заполнить переменные окружения

### Настройка переменных окружения

    DB_HOST=db
    DB_PORT=5432
    DB_USERNAME=db_username
    DB_PASSWORD=db_username_password
    DB_BASENAME=db_dev
    TELEGRAM_BOT_TOKEN=<BOT_TOKEN>
    WEATHER_API_KEY=<WEATHER_TOKEN>
    DEBUG=True
    IMAGE_DIR=/app/images

### Инициализация и настройка базы
    
    Перед выполнением процесса накатывания миграций, изменить DB_HOST на нужный (например, 0.0.0.0)
    Создать директорию для db volume
    $ mkdir resources
    Запустить базу из docker-compose
    $ docker-compose up -d db

    Накатить миграции
    $ alembic upgrade head

    Вернуть DB_HOST на db (для общения между контейнерами)

### Запуск бота

    $ docker-compose up -d telegram_bot
